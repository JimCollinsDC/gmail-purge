<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Auth Test</title>
    <!-- NO CSP for testing -->
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Google Auth Test Page</h1>
    <p>This minimal test page will help identify the exact Google Auth issue.</p>
    
    <div id="status"></div>
    <div id="console-output"></div>
    
    <button onclick="testAuth()">Test Google Auth Initialization</button>
    <button onclick="clearOutput()">Clear Output</button>
    
    <script>
        const CLIENT_ID = '321568043136-rloeh1t90hcgav1p08s9euqk6tg16rft.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';
        
        let statusDiv = document.getElementById('status');
        let consoleDiv = document.getElementById('console-output');
        
        function log(message, type = 'info') {
            console.log(message);
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            consoleDiv.appendChild(div);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        function clearOutput() {
            consoleDiv.innerHTML = '';
            statusDiv.innerHTML = '';
        }
        
        async function testAuth() {
            try {
                log('üöÄ Starting Google Auth test...', 'info');
                log(`üìç Origin: ${window.location.origin}`, 'info');
                log(`üîë Client ID: ${CLIENT_ID}`, 'info');
                
                // Check if gapi is loaded
                if (typeof gapi === 'undefined') {
                    log('‚ùå Google API (gapi) not loaded', 'error');
                    return;
                }
                log('‚úÖ Google API (gapi) is loaded', 'success');
                
                // Load auth2
                log('üîÑ Loading auth2 library...', 'info');
                await new Promise((resolve, reject) => {
                    gapi.load('auth2', {
                        callback: resolve,
                        onerror: reject
                    });
                });
                log('‚úÖ Auth2 library loaded', 'success');
                
                // Initialize auth2
                log('üîÑ Initializing auth2 instance...', 'info');
                const authInstance = await gapi.auth2.init({
                    client_id: CLIENT_ID,
                    scope: SCOPES
                });
                
                if (authInstance) {
                    log('‚úÖ Google Auth2 initialized successfully!', 'success');
                    log(`üë§ Signed in: ${authInstance.isSignedIn.get()}`, 'info');
                    
                    statusDiv.innerHTML = '<div class="status success">‚úÖ Google Auth is working! The issue is not with Google Console configuration.</div>';
                } else {
                    log('‚ùå Auth instance is null', 'error');
                    statusDiv.innerHTML = '<div class="status error">‚ùå Auth initialization returned null</div>';
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                log(`üîç Error details: ${JSON.stringify(error, null, 2)}`, 'error');
                
                if (error.message.includes('idpiframe_initialization_failed')) {
                    statusDiv.innerHTML = `
                        <div class="status error">
                            <strong>‚ùå idpiframe_initialization_failed</strong><br>
                            This error usually means:<br>
                            1. Domain not authorized in Google Console<br>
                            2. CSP blocking Google Auth<br>
                            3. Third-party cookies disabled<br>
                            <br>
                            Since this test page has NO CSP, if you still get this error, 
                            the issue is likely with Google Console configuration or browser settings.
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `<div class="status error">‚ùå Unexpected error: ${error.message}</div>`;
                }
            }
        }
        
        // Auto-run test when page loads
        window.addEventListener('load', () => {
            log('üåê Test page loaded', 'info');
            if (typeof gapi !== 'undefined') {
                log('‚úÖ Google API script detected', 'success');
            } else {
                log('‚è≥ Waiting for Google API script to load...', 'info');
            }
        });
    </script>
    
    <!-- Load Google API -->
    <script src="https://apis.google.com/js/api.js"></script>
</body>
</html>
